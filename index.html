<script>
    // CONFIGURATION CRITIQUE
    const REG_ID = 'IRIS-58-PCC-GLOBAL';
    let fleet = {};

    // FONCTION DE COLLECTE AUTOMATIQUE (Lien avec Python)
    function syncToDatabase(busId, data) {
        // Cette fonction simule l'envoi vers le repo via API ou PeerJS
        const payload = {
            id: busId,
            timestamp: new Date().toISOString(),
            lat: data.lat,
            lon: data.lon,
            gap_front: data.gap_front || "00:00",
            status: data.status || "NORMAL"
        };
        
        // Envoi au PCC pour archivage
        if (conn && conn.open) {
            conn.send({ type: 'archive_data', payload: payload });
        }
        console.log("Données envoyées pour collecte_donnees.py", payload);
    }

    // Mise à jour du radar avec calcul d'écart réel
    function updateFleet(id, data) {
        if(!fleet[id]) {
            fleet[id] = { 
                marker: L.marker([data.lat, data.lon], {
                    icon: L.divIcon({className:'', html:'<div class="bus-ping"></div>'})
                }).addTo(map) 
            };
            logConsole(`UNITÉ ${id} EN LIGNE - AUDIT ACTIF`);
        }
        fleet[id].marker.setLatLng([data.lat, data.lon]);
        syncToDatabase(id, data); // Enregistrement
    }
</script>
