<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRIS v3.2 - Live Radar L58</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap');
        body { background: #02040a; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; overflow: hidden; height: 100vh; margin: 0; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* CARTE ET RADAR */
        #map { height: 100%; width: 100%; background: #02040a; filter: invert(100%) hue-rotate(180deg) brightness(0.6) contrast(0.9); }
        .radar-container { position: relative; width: 100%; height: 100%; border-radius: 20px; overflow: hidden; border: 2px solid #06b6d433; }
        .radar-sweep { position: absolute; inset: 0; z-index: 10; pointer-events: none; background: conic-gradient(from 0deg, transparent 80%, rgba(6, 182, 212, 0.15) 100%); animation: rotate 4s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* INTERFACE CONDUCTEUR */
        .pupitre { background: #111; border: 8px solid #222; border-radius: 40px; box-shadow: inset 0 0 50px #000, 0 20px 50px rgba(0,0,0,0.8); }
        .status-glow { transition: all 0.5s ease; }
        .glow-green { text-shadow: 0 0 20px #22c55e; color: #22c55e; }
        .glow-red { text-shadow: 0 0 20px #ef4444; color: #ef4444; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="selection-screen" class="fixed inset-0 z-[100] bg-[#02040a] flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-10">
            <h1 class="font-orbitron text-4xl mb-2 tracking-[0.4em] text-white">IRIS <span class="text-cyan-500">CORE</span></h1>
            <p class="text-zinc-500 text-[10px] tracking-[0.8em] uppercase">Architecture R√©seau L58</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
            <button onclick="initApp('reg')" class="glass p-12 rounded-3xl border-b-8 border-cyan-600 hover:bg-cyan-500/10 transition-all group">
                <span class="text-5xl block mb-4 group-hover:scale-110 transition-transform">üõ∞Ô∏è</span>
                <span class="font-orbitron font-bold text-xl uppercase tracking-widest text-cyan-400">R√©gulateur</span>
            </button>
            <button onclick="initApp('bus')" class="glass p-12 rounded-3xl border-b-8 border-yellow-600 hover:bg-yellow-500/10 transition-all group">
                <span class="text-5xl block mb-4 group-hover:scale-110 transition-transform">üöå</span>
                <span class="font-orbitron font-bold text-xl uppercase tracking-widest text-yellow-400">Conducteur</span>
            </button>
        </div>
    </div>

    <main id="ui-reg" class="hidden flex-1 flex flex-col p-4 gap-4">
        <header class="flex justify-between items-center bg-zinc-900/80 p-5 rounded-2xl border border-white/5 shadow-2xl">
            <div class="flex items-center gap-4">
                <div class="bg-yellow-400 text-black px-3 py-1 font-black rounded-md">58</div>
                <div class="font-orbitron text-cyan-500 text-lg uppercase tracking-tighter">Poste Central de Commande</div>
            </div>
            <div id="status-tag" class="flex items-center gap-2 text-xs font-bold uppercase text-cyan-600">
                <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-cyan-500"></span></span>
                Scan Fr√©quence Actif
            </div>
        </header>

        <div class="flex-1 grid grid-cols-1 lg:grid-cols-4 gap-4 overflow-hidden">
            <div class="lg:col-span-3 radar-container shadow-2xl">
                <div id="map"></div>
                <div class="radar-sweep"></div>
                <div class="absolute bottom-6 left-6 z-[1000] glass p-3 rounded-lg text-[10px] font-mono border-l-4 border-cyan-500">
                    SATELLITE: ACTIVE <br> ENCRYPT: AES-256
                </div>
            </div>
            
            <div class="flex flex-col gap-4">
                <div class="glass p-5 rounded-2xl flex-1 flex flex-col overflow-hidden">
                    <h4 class="text-[10px] font-black text-zinc-500 uppercase mb-4 tracking-widest">Flux de T√©l√©m√©trie</h4>
                    <div id="reg-console" class="flex-1 overflow-y-auto font-mono text-[11px] text-cyan-400/80 space-y-2 custom-scrollbar"></div>
                </div>
                <button onclick="triggerCouplage()" class="bg-orange-950/30 border-2 border-orange-600 text-orange-500 py-6 rounded-2xl font-black uppercase hover:bg-orange-600 hover:text-white transition-all shadow-lg">
                    Action : Couplage
                </button>
            </div>
        </div>
    </main>

    <main id="ui-bus" class="hidden flex-1 flex items-center justify-center p-6">
        <div class="pupitre w-full max-w-lg aspect-square md:aspect-[4/3] p-10 flex flex-col justify-between text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-30"></div>
            
            <div class="text-7xl font-orbitron text-white tracking-tighter" id="clock">00:00</div>
            
            <div>
                <h2 id="bus-label" class="text-5xl font-black text-zinc-700 uppercase italic status-glow transition-all duration-700">D√©connect√©</h2>
                <p id="bus-sub" class="text-xs text-zinc-500 mt-4 font-mono tracking-[0.3em] uppercase">Syst√®me IRIS v3.2</p>
            </div>

            <div class="grid grid-cols-2 gap-6 mt-4">
                <div class="bg-black/50 p-5 rounded-2xl border border-white/5">
                    <span class="text-[10px] block text-zinc-500 font-bold mb-1 uppercase">Liaison</span>
                    <span id="sig-val" class="text-xl font-black text-zinc-600">OFFLINE</span>
                </div>
                <div class="bg-black/50 p-5 rounded-2xl border border-white/5">
                    <span class="text-[10px] block text-zinc-500 font-bold mb-1 uppercase">Identifiant</span>
                    <span id="id-val" class="text-xl font-black text-white">#---</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        let myRole = '';
        let map, marker, peer, conn;
        const REG_ID = 'iris-58-pcc-central'; // ID FIXE POUR LE REGULATEUR

        function initApp(role) {
            myRole = role;
            document.getElementById('selection-screen').classList.add('hidden');
            if(role === 'reg') {
                document.getElementById('ui-reg').classList.remove('hidden');
                startRegulateur();
            } else {
                document.getElementById('ui-bus').classList.remove('hidden');
                startMachiniste();
            }
        }

        // --- LOGIQUE R√âGULATEUR (PC) ---
        function startRegulateur() {
            // Initialisation Carte
            map = L.map('map', {zoomControl: false}).setView([48.8566, 2.3522], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            peer = new Peer(REG_ID);
            peer.on('open', () => logConsole("Radar initialis√©. En attente d'unit√©s..."));
            
            peer.on('connection', (connection) => {
                conn = connection;
                logConsole("CONNEXION √âTABLIE : UNIT√â L58");
                
                conn.on('data', (data) => {
                    if(data.type === 'gps') {
                        updateRadar(data.lat, data.lon);
                        logConsole(`COORD: ${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}`);
                    }
                });
            });
        }

        function updateRadar(lat, lon) {
            if(!marker) {
                marker = L.circleMarker([lat, lon], {
                    radius: 12, color: '#00f2ff', fillColor: '#00f2ff', fillOpacity: 0.6, weight: 2
                }).addTo(map);
                marker.bindTooltip("UNIT√â 58", {permanent: true, direction: 'right', className: 'font-bold'});
                map.setView([lat, lon], 16); // Centrage imm√©diat au premier signal
            } else {
                marker.setLatLng([lat, lon]);
                map.panTo([lat, lon]); // Suivi fluide
            }
        }

        // --- LOGIQUE MACHINISTE (MOBILE) ---
        function startMachiniste() {
            const myId = 'BUS-' + Math.floor(100 + Math.random() * 899);
            document.getElementById('id-val').innerText = myId;
            
            peer = new Peer(myId);

            peer.on('open', () => {
                document.getElementById('sig-val').innerText = "PEER READY";
                document.getElementById('sig-val').classList.add('text-cyan-500');
                
                // Connexion automatique au PCC
                const connectToPCC = () => {
                    conn = peer.connect(REG_ID);
                    conn.on('open', () => {
                        const lbl = document.getElementById('bus-label');
                        lbl.innerText = "Connect√©";
                        lbl.classList.add('glow-green');
                        document.getElementById('sig-val').innerText = "LINK OK";
                        document.getElementById('sig-val').style.color = "#22c55e";
                        startGpsStream();
                    });
                };
                setTimeout(connectToPCC, 1500);
            });

            function startGpsStream() {
                setInterval(() => {
                    if (navigator.geolocation && conn && conn.open) {
                        navigator.geolocation.getCurrentPosition((p) => {
                            conn.send({type: 'gps', lat: p.coords.latitude, lon: p.coords.longitude});
                        }, (err) => console.error("Erreur GPS:", err), 
                        { enableHighAccuracy: true });
                    }
                }, 4000); // Transmission toutes les 4 secondes
            }

            // R√©ception des ordres
            peer.on('connection', (c) => {
                c.on('data', (data) => {
                    if(data.action === 'couplage') {
                        document.body.style.background = "#2d0a0a";
                        const lbl = document.getElementById('bus-label');
                        lbl.innerText = "ORDRE : COUPLAGE";
                        lbl.classList.replace('glow-green', 'glow-red');
                        lbl.classList.add('animate-pulse');
                    }
                });
            });
        }

        function triggerCouplage() {
            if(conn && conn.open) {
                conn.send({action: 'couplage'});
                logConsole("COMMANDE : COUPLAGE LIGNE ENVOY√âE");
            } else {
                logConsole("ERREUR : AUCUNE UNIT√â CONNECT√âE");
            }
        }

        function logConsole(msg) {
            const c = document.getElementById('reg-console');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            c.innerHTML = `<div class="border-l border-cyan-900 pl-2"><span class="text-cyan-800">[${time}]</span> ${msg}</div>` + c.innerHTML;
        }

        // Horloge
        setInterval(() => {
            const d = new Date();
            const t = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
            if(document.getElementById('clock')) document.getElementById('clock').innerText = t;
        }, 1000);
    </script>
</body>
</html>
