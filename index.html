<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRIS CORE v4.8 - L58 System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap');
        body { background: #02040a; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; overflow: hidden; height: 100vh; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        #map-reg, #map-bus { height: 100%; width: 100%; background: #02040a; filter: invert(100%) hue-rotate(180deg) brightness(0.7); }
        .emergency-active { animation: emergency-flash 0.5s infinite alternate; }
        @keyframes emergency-flash { from { background: #02040a; } to { background: #450a0a; } }
        .status-blink { animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body class="flex flex-col h-screen transition-colors duration-500" id="main-body">

    <div id="selection-screen" class="fixed inset-0 z-[100] bg-[#02040a] flex flex-col items-center justify-center p-6">
        <h1 class="font-orbitron text-4xl mb-12 tracking-[0.4em] text-white">IRIS <span class="text-cyan-500">CORE</span></h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl">
            <button onclick="initApp('reg')" class="glass p-12 rounded-3xl border-b-8 border-cyan-600 hover:scale-105 transition-all text-center">
                <span class="text-5xl block mb-4">üõ∞Ô∏è</span>
                <span class="font-orbitron text-xl text-cyan-400">PCC OP√âRATEUR</span>
            </button>
            <button onclick="initApp('bus')" class="glass p-12 rounded-3xl border-b-8 border-yellow-600 hover:scale-105 transition-all text-center">
                <span class="text-5xl block mb-4">üöå</span>
                <span class="font-orbitron text-xl text-yellow-500">POSTE CONDUITE</span>
            </button>
        </div>
    </div>

    <main id="ui-reg" class="hidden flex-1 flex flex-col p-4 gap-4">
        <header class="flex justify-between items-center glass p-4 rounded-2xl border-cyan-500/20">
            <div class="flex items-center gap-4">
                <div class="bg-yellow-400 text-black px-4 py-1 font-black rounded text-xl">58</div>
                <h2 class="font-orbitron text-cyan-500 text-lg uppercase">Surveillance Flotte</h2>
            </div>
            <div id="status-indicator" class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-cyan-500 status-blink"></div>
                <span class="text-[10px] font-bold text-cyan-500 uppercase tracking-widest">IRIS Online</span>
            </div>
        </header>

        <div class="flex-1 grid grid-cols-4 gap-4 overflow-hidden">
            <div class="col-span-3 relative rounded-2xl overflow-hidden border border-white/10 shadow-2xl">
                <div id="map-reg"></div>
            </div>
            <aside class="flex flex-col gap-4">
                <div id="bus-list" class="flex-1 overflow-y-auto space-y-3">
                    </div>
                <div class="glass p-4 rounded-2xl h-40 overflow-y-auto text-[10px] font-mono text-cyan-400 italic" id="reg-console">
                    [SYSTEM READY]
                </div>
            </aside>
        </div>
    </main>

    <main id="ui-bus" class="hidden flex-1 flex flex-col p-2 gap-2 bg-[#050505]">
        <div class="grid grid-cols-3 gap-2 h-20">
            <div class="glass rounded-xl p-2 border-l-4 border-yellow-500 flex flex-col justify-center">
                <p class="text-[8px] text-zinc-500 uppercase font-bold">Pr√©c√©dent (N-1)</p>
                <div class="flex justify-between items-baseline"><span id="gap-front-time" class="text-lg font-orbitron text-white">--:--</span><span id="gap-front-dist" class="text-[10px] text-yellow-500">0m</span></div>
            </div>
            <div class="glass rounded-xl p-2 border-t-4 border-cyan-500 flex flex-col items-center justify-center">
                <p class="text-[8px] text-cyan-500 uppercase font-bold">L58</p>
                <span id="bus-id-label" class="text-xs font-bold text-white tracking-widest">--</span>
            </div>
            <div class="glass rounded-xl p-2 border-r-4 border-green-500 text-right flex flex-col justify-center">
                <p class="text-[8px] text-zinc-500 uppercase font-bold">Suivant (N+1)</p>
                <div class="flex justify-between items-baseline flex-row-reverse"><span id="gap-back-time" class="text-lg font-orbitron text-white">--:--</span><span id="gap-back-dist" class="text-[10px] text-green-500">0m</span></div>
            </div>
        </div>

        <div class="relative flex-1 rounded-2xl overflow-hidden border border-white/10">
            <div id="map-bus"></div>
            <div class="absolute bottom-4 left-4 right-4 glass p-4 rounded-2xl border-t-4 border-cyan-500 z-[1000]">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] text-zinc-400 font-bold uppercase">Prochain Arr√™t : <span class="text-white">PONT DE LA VALL√âE</span></span>
                    <span class="text-cyan-400 font-orbitron text-[10px]" id="clock-bus">00:00</span>
                </div>
                <div class="h-1.5 bg-zinc-800 rounded-full"><div id="progress" class="h-full bg-cyan-500 w-1/3 shadow-[0_0_10px_#06b6d4]"></div></div>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-2 h-16">
            <button onclick="triggerEmergency()" class="bg-red-900/40 rounded-xl flex items-center justify-center border-b-4 border-red-600 text-[10px] font-bold">üö® COUPLAGE</button>
            <button class="glass rounded-xl flex items-center justify-center border-b-4 border-blue-600 text-[10px] font-bold uppercase">Appel</button>
            <button class="glass rounded-xl flex items-center justify-center border-b-4 border-zinc-600 text-[10px] font-bold uppercase">R√©gulez</button>
            <button class="glass rounded-xl flex items-center justify-center border-b-4 border-green-600 text-[10px] font-bold uppercase">OK</button>
        </div>
    </main>

    <script>
        let myRole = '', peer = null, conn = null, map = null, marker = null;
        const REG_ID = 'iris-58-pcc-central-2026';
        let fleet = {}; 

        function initApp(role) {
            myRole = role;
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById(`ui-${role}`).classList.remove('hidden');
            role === 'reg' ? startReg() : startBus();
        }

        // --- MOTEUR R√âGULATEUR ---
        function startReg() {
            setTimeout(() => {
                map = L.map('map-reg', {zoomControl: false}).setView([48.8285, 2.3061], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
                
                peer = new Peer(REG_ID);
                peer.on('connection', (c) => {
                    c.on('data', (data) => handleData(data, c.peer, c));
                });
            }, 200);
        }

        function handleData(data, senderId, connection) {
            if(data.type === 'gps') {
                if(!fleet[senderId]) logConsole(`Liaison avec ${senderId} √©tablie`);
                fleet[senderId] = { lat: data.lat, lon: data.lon, lastSeen: new Date(), conn: connection };
                updateRegUI(senderId);
                broadcastFleet();
            }
        }

        function updateRegUI(id) {
            const list = document.getElementById('bus-list');
            let el = document.getElementById(`list-${id}`);
            if(!el) {
                el = document.createElement('div');
                el.id = `list-${id}`;
                el.className = "glass p-4 rounded-xl border-l-4 border-cyan-500 flex justify-between";
                list.appendChild(el);
            }
            el.innerHTML = `<span class="font-bold text-white">${id}</span><span class="text-cyan-500 font-mono text-xs">EN LIGNE</span>`;
        }

        function broadcastFleet() {
            const ids = Object.keys(fleet);
            ids.forEach(id => {
                const c = fleet[id].conn;
                if(c && c.open) {
                    // Ici on simule le calcul d'√©cart pour la d√©mo
                    c.send({type: 'fleet_sync', front: {time: '4:20', dist: '850m'}, back: {time: '6:15', dist: '1.2km'}});
                }
            });
        }

        // --- MOTEUR MACHINISTE ---
        function startBus() {
            const busId = 'L58-' + Math.floor(Math.random()*900+100);
            document.getElementById('bus-id-label').innerText = busId;
            
            setTimeout(() => {
                map = L.map('map-bus', {zoomControl: false}).setView([48.8285, 2.3061], 16);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
                marker = L.circleMarker([48.8285, 2.3061], {radius: 8, color: '#06b6d4', fillOpacity: 1}).addTo(map);

                peer = new Peer(busId);
                peer.on('open', () => {
                    conn = peer.connect(REG_ID);
                    setupGps();
                });

                peer.on('connection', (c) => {
                    c.on('data', (d) => {
                        if(d.type === 'fleet_sync') {
                            document.getElementById('gap-front-time').innerText = d.front.time;
                            document.getElementById('gap-front-dist').innerText = d.front.dist;
                            document.getElementById('gap-back-time').innerText = d.back.time;
                            document.getElementById('gap-back-dist').innerText = d.back.dist;
                        }
                    });
                });
            }, 200);
        }

        function setupGps() {
            navigator.geolocation.watchPosition(p => {
                const pos = [p.coords.latitude, p.coords.longitude];
                marker.setLatLng(pos);
                map.panTo(pos);
                if(conn && conn.open) conn.send({type: 'gps', lat: pos[0], lon: pos[1]});
            }, null, {enableHighAccuracy: true});
        }

        function logConsole(m) {
            const c = document.getElementById('reg-console');
            c.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${m}</div>` + c.innerHTML;
        }

        setInterval(() => {
            const now = new Date();
            const time = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            if(document.getElementById('clock')) document.getElementById('clock').innerText = time;
            if(document.getElementById('clock-bus')) document.getElementById('clock-bus').innerText = time;
        }, 1000);
    </script>
</body>
</html>
