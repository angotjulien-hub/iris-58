<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRIS v3.5 - PCC LIGNE 58</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root { --iris-blue: #00f2ff; --iris-alert: #ff3e3e; --iris-bg: #0a0a0a; }
        body, html { margin: 0; padding: 0; background: var(--iris-bg); font-family: 'Rajdhani', sans-serif; color: white; overflow: hidden; height: 100%; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #0a0a0a; }

        .pcc-overlay {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(10, 10, 10, 0.9); border-left: 4px solid var(--iris-blue);
            padding: 15px; width: 320px; box-shadow: 0 0 25px rgba(0,0,0,0.7);
            pointer-events: none;
        }
        .status-badge {
            display: inline-block; padding: 2px 8px; border: 1px solid var(--iris-blue);
            color: var(--iris-blue); font-family: 'Orbitron', sans-serif; font-size: 10px; margin-bottom: 10px;
        }
        #reg-console {
            height: 150px; overflow-y: auto; font-family: monospace; font-size: 10px;
            color: #aaa; border-top: 1px solid #333; margin-top: 10px; padding-top: 10px;
        }
        .bus-ping { 
            width: 14px; height: 14px; background: var(--iris-blue); 
            border-radius: 50%; animation: pulse 1.8s infinite; border: 2px solid white; 
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3.5); opacity: 0; } }
        
        .bus-label { 
            background: transparent !important; border: none !important; 
            color: var(--iris-blue) !important; font-weight: 700; font-family: 'Orbitron';
            text-shadow: 2px 2px 4px #000; font-size: 12px;
        }
        .alert-msg { color: var(--iris-alert); font-weight: bold; animation: blink 0.5s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.5; } }

        /* Style pour rendre le bouton cliquable au-dessus de l'overlay */
        .btn-collecte {
            pointer-events: auto; background: #111; border: 1px solid #333;
            color: #666; font-size: 9px; padding: 5px; margin-top: 10px; width: 100%;
            transition: all 0.3s;
        }
        .btn-collecte:hover { color: var(--iris-blue); border-color: var(--iris-blue); }
    </style>
</head>
<body>

    <div class="pcc-overlay">
        <div class="status-badge">IRIS SYSTEM ACTIVE</div>
        <h1 class="text-xl font-bold font-['Orbitron'] tracking-wider text-white">PCC LIGNE 58</h1>
        <div class="text-[10px] text-zinc-500 uppercase mt-1">Secteur : Alésia - 13 Unités</div>
        <div id="reg-console"><div>[SYSTEM] Initialisation...</div></div>
        <button class="btn-collecte" onclick="exportHistory()">TÉLÉCHARGER COLLECTE (JSON)</button>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let fleet = {};
        let paths = {}; // Tracé des chemins
        let historyData = []; // Collecte de données (08/02)
        const PCC_ID = 'IRIS-PCC-58-GLOBAL';

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([48.828, 2.327], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CartoDB'
            }).addTo(map);
            
            logConsole("CARTE CHARGÉE - SCANNER PRÊT");
            initPeer();
        }

        function logConsole(msg, isAlert = false) {
            const consoleDiv = document.getElementById('reg-console');
            const time = new Date().toLocaleTimeString();
            const style = isAlert ? 'class="alert-msg"' : '';
            consoleDiv.innerHTML = `<div class="mb-1" ${style}><span>[${time}]</span> ${msg}</div>` + consoleDiv.innerHTML;
        }

        function updateBus(id, lat, lon) {
            const pos = [lat, lon];
            
            // Enregistrement pour la collecte de données
            historyData.push({ id, lat, lon, t: new Date().toISOString() });

            if (!fleet[id]) {
                // Création du bus
                fleet[id] = L.marker(pos, {
                    icon: L.divIcon({ className: '', html: '<div class="bus-ping"></div>' })
                }).addTo(map).bindTooltip(id, { 
                    permanent: true, direction: 'top', className: 'bus-label', offset: [0, -10] 
                });

                // Initialisation du tracé (chemin)
                paths[id] = L.polyline([pos], {
                    color: '#00f2ff',
                    weight: 2,
                    opacity: 0.4,
                    dashArray: '5, 10'
                }).addTo(map);

                logConsole(`UNITÉ ${id} CONNECTÉE`);
            } else {
                // Mise à jour position et tracé
                fleet[id].setLatLng(pos);
                paths[id].addLatLng(pos);
            }

            checkCouplage(id, L.latLng(lat, lon));
        }

        function checkCouplage(busId, busPos) {
            Object.keys(fleet).forEach(otherId => {
                if (busId !== otherId) {
                    const dist = busPos.distanceTo(fleet[otherId].getLatLng());
                    if (dist < 150) {
                        logConsole(`ALERTE COUPLAGE : ${busId} & ${otherId}`, true);
                    }
                }
            });
        }

        function initPeer() {
            const peer = new Peer(PCC_ID, { debug: 2 });

            peer.on('open', (id) => {
                logConsole("CANAL RÉSEAU ÉTABLI : " + id);
            });

            peer.on('connection', (conn) => {
                logConsole(`FLUX ENTRANT : CONNEXION ÉTABLIE`);
                conn.on('data', (data) => {
                    if (data.type === 'position') {
                        updateBus(data.id, data.lat, data.lon);
                    }
                });
            });

            peer.on('error', (err) => {
                logConsole("ERREUR RÉSEAU : " + err.type, true);
            });
        }

        function exportHistory() {
            if (historyData.length === 0) return alert("Aucune donnée collectée.");
            const blob = new Blob([JSON.stringify(historyData, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `collecte_58_${new Date().getTime()}.json`;
            a.click();
        }

        window.onload = initMap;
    </script>
</body>
</html>
