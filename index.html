<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRIS v3.0 - PCC LIGNE 58</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root { --iris-blue: #00f2ff; --iris-bg: #0a0a0a; }
        body, html { margin: 0; padding: 0; background: var(--iris-bg); font-family: 'Rajdhani', sans-serif; color: white; overflow: hidden; height: 100%; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #0a0a0a; }

        .pcc-overlay {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(10, 10, 10, 0.9); border-left: 4px solid var(--iris-blue);
            padding: 15px; width: 320px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        .status-badge {
            display: inline-block; padding: 2px 8px; border: 1px solid var(--iris-blue);
            color: var(--iris-blue); font-family: 'Orbitron', sans-serif; font-size: 10px; margin-bottom: 10px;
        }
        #reg-console {
            height: 120px; overflow-y: auto; font-family: monospace; font-size: 11px;
            color: #888; border-top: 1px solid #333; margin-top: 10px; padding-top: 10px;
        }
        .bus-ping { 
            width: 12px; height: 12px; background: var(--iris-blue); 
            border-radius: 50%; animation: pulse 1.5s infinite; border: 2px solid white; 
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }
        
        /* Style des étiquettes IDs */
        .bus-label { 
            background: transparent !important; border: none !important; 
            box-shadow: none !important; color: var(--iris-blue) !important; 
            font-weight: bold; font-family: 'Orbitron'; text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>
    <div class="pcc-overlay">
        <div class="status-badge">IRIS SYSTEM ACTIVE</div>
        <h1 class="text-xl font-bold font-['Orbitron'] tracking-wider">PCC LIGNE 58</h1>
        <div id="reg-console"><div>[SYSTEM] Initialisation...</div></div>
    </div>
    <div id="map"></div>

    <script>
        let map;
        let fleet = {};
        const PCC_ID = 'IRIS-PCC-58-GLOBAL';

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([48.828, 2.327], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CartoDB'
            }).addTo(map);
            logConsole("CARTE CHARGÉE - SECTEUR ALÉSIA");
            initPeer();
        }

        function logConsole(msg) {
            const consoleDiv = document.getElementById('reg-console');
            const time = new Date().toLocaleTimeString();
            consoleDiv.innerHTML = `<div class="mb-1"><span class="text-[#00f2ff]">[${time}]</span> ${msg}</div>` + consoleDiv.innerHTML;
        }

        function updateBus(id, lat, lon) {
            if (!fleet[id]) {
                // Création du bus avec son ID visible pour la régulation
                fleet[id] = L.marker([lat, lon], {
                    icon: L.divIcon({ className: '', html: '<div class="bus-ping"></div>' })
                }).addTo(map).bindTooltip(id, { 
                    permanent: true, 
                    direction: 'top', 
                    className: 'bus-label' 
                });
                logConsole(`UNITÉ ${id} DÉTECTÉE`);
            } else {
                fleet[id].setLatLng([lat, lon]);
            }
        }

        function initPeer() {
            const peer = new Peer(PCC_ID);

            peer.on('open', (id) => {
                logConsole("CANAL RÉSEAU PRÊT : " + id);
            });

            peer.on('connection', (conn) => {
                logConsole("CONNEXION CHAUFFEUR ÉTABLIE");
                conn.on('data', (data) => {
                    if (data.type === 'position') {
                        updateBus(data.id, data.lat, data.lon);
                    }
                });
            });

            peer.on('error', (err) => {
                logConsole("ERREUR : " + err.type);
                if(err.type === 'unavailable-id') {
                    logConsole("ID déjà utilisé. Tentative de reconnexion...");
                }
            });
        }

        window.onload = initMap;
    </script>
</body>
</html>
