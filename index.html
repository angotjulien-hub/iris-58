<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRIS L58 - FINAL STABLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap');
        body { background: #02040a; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .pupitre { background: #111; border: 10px solid #222; border-radius: 40px; box-shadow: inset 0 0 60px #000; padding: 40px; position: relative; border-bottom-width: 20px; }
        #map { height: 100%; width: 100%; background: #02040a; filter: invert(100%) hue-rotate(180deg) brightness(0.8); }
        .status-glow { box-shadow: 0 0 15px rgba(34, 197, 94, 0.2); }
    </style>
</head>
<body class="flex items-center justify-center">

    <div id="selection" class="text-center z-50">
        <h1 class="font-orbitron text-4xl mb-12 tracking-widest text-white">IRIS <span class="text-cyan-500">L58</span></h1>
        <div class="space-y-4">
            <button onclick="launch('driver')" class="w-64 bg-zinc-900 border-2 border-white/5 p-6 rounded-2xl block hover:border-cyan-500 transition-all font-bold tracking-widest uppercase">Conducteur üöå</button>
            <button onclick="launch('reg')" class="w-64 bg-zinc-900 border-2 border-white/5 p-6 rounded-2xl block hover:border-yellow-500 transition-all font-bold tracking-widest uppercase">R√©gulateur üõ∞Ô∏è</button>
        </div>
    </div>

    <div id="ui-driver" class="hidden pupitre w-[92%] max-w-[400px] text-center">
        <div class="flex justify-between items-center mb-10">
            <div id="led" class="w-3 h-3 rounded-full bg-red-600 shadow-[0_0_10px_red]"></div>
            <div class="bg-yellow-400 text-black px-3 py-1 font-black rounded italic text-xs">LIGNE 58</div>
        </div>
        <div id="clock" class="text-7xl font-orbitron text-white mb-2">00:00</div>
        <div id="coords" class="text-cyan-400 font-mono text-sm mb-12 tracking-tighter h-5">RECHERCHE SIGNAL...</div>
        
        <button id="btn-couple" onclick="this.classList.toggle('bg-orange-600'); this.classList.toggle('text-white')" class="w-full bg-zinc-800/50 border border-white/10 py-5 rounded-2xl font-orbitron text-[10px] tracking-[0.2em] text-zinc-500 transition-all">
            COUPLAGE PRIORITAIRE
        </button>
    </div>

    <div id="ui-reg" class="hidden fixed inset-0">
        <div id="map"></div>
        <div class="absolute top-5 left-5 z-[1000] bg-black/90 p-4 rounded-xl border border-white/10 backdrop-blur-md">
            <div class="text-cyan-500 font-orbitron text-xs">PCC L58 ACTIVE</div>
            <div id="reg-log" class="text-[9px] uppercase text-zinc-500 font-bold mt-1">Scanner en cours...</div>
        </div>
    </div>

    <script>
        let peer, conn, map, marker;
        const BUS_ID = "IRIS-BUS-58-OFFICIAL";

        function launch(role) {
            document.getElementById('selection').style.display = 'none';
            if(role === 'driver') {
                document.getElementById('ui-driver').classList.remove('hidden');
                initDriver();
            } else {
                document.getElementById('ui-reg').classList.remove('hidden');
                initRegulator();
            }
        }

        // --- PARTIE CHAUFFEUR ---
        function initDriver() {
            // 1. Horloge imm√©diate
            const updateTime = () => {
                const d = new Date();
                document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
            };
            setInterval(updateTime, 1000); updateTime();

            // 2. GPS PRIORITAIRE (Ne d√©pend pas de PeerJS)
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition((p) => {
                    const lat = p.coords.latitude;
                    const lon = p.coords.longitude;
                    document.getElementById('coords').innerText = `LAT ${lat.toFixed(5)} | LON ${lon.toFixed(5)}`;
                    if (conn && conn.open) conn.send({ lat, lon });
                }, (e) => {
                    document.getElementById('coords').innerText = "ERREUR: GPS BLOQU√â";
                }, { enableHighAccuracy: true });
            }

            // 3. PeerJS en arri√®re-plan
            peer = new Peer(BUS_ID);
            peer.on('open', () => {
                document.getElementById('led').className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
            });
            peer.on('connection', (c) => { 
                conn = c; 
                document.getElementById('coords').style.color = "#ffffff";
            });
        }

        // --- PARTIE R√âGULATEUR ---
        function initRegulator() {
            map = L.map('map', { zoomControl: false }).setView([48.8566, 2.3522], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            peer = new Peer();
            peer.on('open', () => {
                const connect = () => {
                    const c = peer.connect(BUS_ID);
                    c.on('open', () => {
                        document.getElementById('reg-log').innerText = "BUS CONNECT√â";
                        c.on('data', (data) => {
                            if (!marker) {
                                marker = L.circleMarker([data.lat, data.lon], { color: '#06b6d4', radius: 10, fillOpacity: 1 }).addTo(map);
                                map.setView([data.lat, data.lon], 16);
                            } else {
                                marker.setLatLng([data.lat, data.lon]);
                            }
                        });
                    });
                    c.on('error', () => setTimeout(connect, 4000));
                };
                connect();
            });
        }
    </script>
</body>
</html>
