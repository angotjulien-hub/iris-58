import pandas as pd
import os
from datetime import datetime

class IrisEngine:
    def __init__(self, ref_folder="referentiel"):
        self.ref_folder = ref_folder
        self.km_par_tour = 8.5  # Distance moyenne L58
        self.seuil_couplage = 1.5 # 150% de l'intervalle (RÃ¨gle IRIS)

    def select_file(self):
        """SÃ©lectionne le fichier selon le jour de la semaine (Data 2026)"""
        today = datetime.now().weekday()
        mapping = {0: "058LAV10.csv", 1: "058LAV10.csv", 2: "058LAV10.csv", 
                   3: "058LAV10.csv", 4: "058LAV10.csv", 5: "058SAM30.csv", 6: "058DIM10.csv"}
        return os.path.join(self.ref_folder, mapping[today])

    def clean_and_load(self, file_path):
        """Nettoie les guillemets illÃ©gaux et charge les donnÃ©es"""
        try:
            # On lit le fichier en ignorant les erreurs de guillemets (quoting=3)
            df = pd.read_csv(file_path, sep=';', encoding='utf-8', quoting=3)
            
            # Nettoyage des noms de colonnes (suppression des " et espaces)
            df.columns = [c.replace('"', '').strip() for c in df.columns]
            
            # Nettoyage des valeurs dans toutes les cellules (enlÃ¨ve les ")
            df = df.replace('"', '', regex=True)
            
            return df
        except Exception as e:
            print(f"âŒ Erreur lecture CSV : {e}")
            return None

    def calculer_audit(self, df):
        """Calcule la performance selon la prioritÃ© FrÃ©quence > KilomÃ¨tre"""
        if df is None: return
        
        nb_tours_theoriques = len(df['Voiture'].unique()) if 'Voiture' in df.columns else len(df)
        
        # Simulation des donnÃ©es terrain (Collecte 2026)
        tours_perdus_regul = 2  # Tours sacrifiÃ©s pour boucher un trou (Couplage)
        km_bonus_jaures = 0.4 * (nb_tours_theoriques - tours_perdus_regul) # DÃ©viation Jean JaurÃ¨s
        
        km_theo_total = nb_tours_theoriques * self.km_par_tour
        km_reels_total = (nb_tours_theoriques - tours_perdus_regul) * self.km_par_tour + km_bonus_jaures
        
        rot = (km_reels_total / km_theo_total) * 100
        
        self.afficher_rapport(nb_tours_theoriques, tours_perdus_regul, rot, km_bonus_jaures)

    def afficher_rapport(self, theo, perdus, rot, bonus):
        print("="*40)
        print("ğŸ“Š RAPPORT AUDIT IRIS PRIME - LIGNE 58")
        print("="*40)
        print(f"âœ… Offre thÃ©orique  : {theo} tours")
        print(f"ğŸ”„ RÃ©gulation IRIS  : -{perdus} tours (PrioritÃ© FrÃ©quence)")
        print(f"ğŸ›£ï¸ DÃ©viation JaurÃ¨s : +{bonus:.2f} km effectuÃ©s")
        print(f"ğŸ“ˆ Taux ROT Final   : {rot:.2f} %")
        print("-"*40)
        print("ğŸ’¡ Note Audit : La baisse de ROT est justifiÃ©e par")
        print("   le maintien de l'intervalle au verrou 18 Juin.")
        print("="*40)

# --- LANCEMENT DE L'ENGINE ---
if __name__ == "__main__":
    iris = IrisEngine()
    target_file = iris.select_file()
    
    if os.path.exists(target_file):
        data = iris.clean_and_load(target_file)
        iris.calculer_audit(data)
    else:
        print(f"âš ï¸ Fichier {target_file} introuvable dans /referentiel")
